# 双摄像头检测功能使用说明

## 概述

此项目实现了基于DV和DVS双摄像头的物体检测功能，使用YOLOv5的libtorch模型进行实时目标检测，并根据两个摄像头的检测结果产生最终判决。

## 功能特性

1. **双摄像头检测**: 同时对DV和DVS摄像头的图像进行目标检测
2. **实时结果显示**: 检测结果直接在UI的原视图上显示，包括检测框和类别信息
3. **时间同步**: 根据时间戳对齐两个摄像头的检测结果
4. **智能判决**: 综合两个摄像头的检测结果，产生最终的检测判决
5. **结果记录**: 所有检测结果和最终判决保存到文本文件中

## 项目结构

```
├── infer/detect/
│   ├── DetectModule_DV.h/cpp          # DV检测模块
│   ├── DetectModule_DVS.h/cpp         # DVS检测模块
│   ├── TorchEngine_DV.h/cpp           # DV的PyTorch推理引擎
│   ├── TorchEngine_DVS.h/cpp          # DVS的PyTorch推理引擎
│   └── DualCameraResultManager.h/cpp # 双摄像头结果管理器
├── detection_config.json              # 检测配置文件
└── DETECTION_README.md                # 使用说明文档
```

## 配置要求

### 硬件要求
- DV摄像头（普通摄像头）
- DVS摄像头（事件摄像头）
- 支持CUDA的GPU（推荐）

### 软件依赖
- PyTorch C++ (libtorch) 1.13.0+
- OpenCV 4.2+
- Qt5
- CUDA 11.6+ (可选，用于GPU加速)

### 模型文件
需要准备以下YOLOv5 TorchScript模型文件：
- `models/yolov5_dv.pt` - DV摄像头检测模型
- `models/yolov5_dvs.pt` - DVS摄像头检测模型

## 编译

1. 确保已安装所有依赖项
2. 配置CMakeLists.txt中的路径：
   - CUDA路径
   - libtorch路径
   - TensorRT路径（如果使用）

3. 编译项目：
```bash
mkdir build && cd build
cmake ..
make -j$(nproc)
```

## 使用方法

### 1. 启动程序

运行程序后，您将看到双摄像头检测系统的主界面。

### 2. 启动检测功能

1. **启用检测**: 在UI界面中勾选"启用检测功能"复选框
2. **配置模型路径**: 确保`dv_dvs.json`中的模型路径正确
3. **启动摄像头**: 点击"启动相机"按钮

### 3. UI显示逻辑

系统采用智能显示切换逻辑：

- **相机模式**: 当检测功能未启用时，显示原始相机画面
- **检测模式**: 当检测功能启用时，显示带有检测框和标注的检测结果画面

这样可以清晰地区分相机采集状态和检测分析状态。

### 4. 检测流程

1. **图像采集**: 同时从DV和DVS摄像头获取图像
2. **预处理**: 图像缩放、归一化等
3. **模型推理**: 分别对两个摄像头的图像进行YOLOv5检测
4. **结果处理**: NMS（非极大值抑制）、置信度筛选
5. **时间对齐**: 根据时间戳匹配两个摄像头的检测结果
6. **最终判决**: 综合分析产生最终检测结果

### 5. 结果显示与保存

- **DV检测结果**: 显示在DV视图上，带有检测框和置信度
- **DVS检测结果**: 显示在DVS视图上，带有检测框和置信度
- **检测信息**: UI底部显示实时检测结果文本
- **最终判决**: 显示综合两个摄像头结果的最终判决
- **检测结果图片**: 自动保存带有检测框的结果图片到专门的目录

### 6. 检测时录制功能

当启用检测功能时，系统会自动创建专门的录制会话：

- **文件夹命名**: 包含"detect"后缀，如`2025-01-26_14-30-15_detect`
- **检测结果图片**: 保存到`detection_results/dv/`和`detection_results/dvs/`子目录
- **限流保存**: 每2秒最多保存一张检测结果图片，避免产生过多文件
- **智能触发**: 配置`recordingWithDetection: true`时，检测到目标会自动启动录制

### 7. 文件夹结构

检测时录制会创建以下文件结构：

```
recordings/
├── 2025-01-26_14-30-15_detect/
│   ├── dv_original/                 # DV原始图像
│   ├── dv_cropped/                  # DV裁剪图像
│   ├── dvs_images/                  # DVS可视化图像
│   ├── dvs_raw/                     # DVS原始数据
│   └── detection_results/           # 检测结果图片
│       ├── dv/                      # DV检测结果图片
│       │   └── dv_detection_*.png
│       └── dvs/                     # DVS检测结果图片
│           └── dvs_detection_*.png
└── 2025-01-26_14-35-22_dv_detect/   # DV检测触发的录制
    └── ...
```

## 配置参数

### detection_config.json 配置说明

```json
{
  "detection": {
    "enabled": false,                    // 是否默认启用检测
    "time_window_ms": 100,              // 时间窗口，用于同步两个摄像头结果
    "output_file": "detection_results.txt", // 结果输出文件
    "models": {
      "dv_model_path": "models/yolov5_dv.pt",   // DV模型路径
      "dvs_model_path": "models/yolov5_dvs.pt"  // DVS模型路径
    },
    "parameters": {
      "dv": {
        "confidence_threshold": 0.45,    // DV置信度阈值
        "iou_threshold": 0.2,           // DV IOU阈值
        "input_width": 640,             // 输入图像宽度
        "input_height": 384,            // 输入图像高度
        "num_classes": 10               // 类别数量
      }
    }
  }
}
```

## 检测类别

当前支持的检测类别：
1. starfish (海星)
2. seahorse (海马)
3. crab (螃蟹)
4. turtle (海龟)
5. whale (鲸鱼)
6. car1 (汽车1)
7. car2 (汽车2)
8. car3 (汽车3)
9. tank (坦克)
10. helicopter (直升机)

## 最终判决规则

系统根据以下规则产生最终判决：

1. **一致检测**: 两个摄像头检测到相同类别，取平均置信度
2. **冲突检测**: 检测到不同类别，根据置信度高低决定优先级
3. **单摄像头检测**: 只有一个摄像头检测到目标
4. **无检测**: 两个摄像头都未检测到目标

## 输出文件格式

检测结果保存在文本文件中，格式如下：
```
2024-01-15 10:30:25.123 - 一致检测: crab (平均置信度: 0.85)
2024-01-15 10:30:25.623 - 冲突检测(DV优先): turtle (置信度: 0.78) vs crab (置信度: 0.65)
2024-01-15 10:30:26.123 - DV单独检测: starfish (置信度: 0.82)
2024-01-15 10:30:26.623 - 无检测结果
```

## 故障排除

### 常见问题

1. **模型加载失败**
   - 检查模型文件路径是否正确
   - 确认模型文件格式为TorchScript (.pt)
   - 检查CUDA环境配置

2. **检测速度慢**
   - 确认GPU驱动和CUDA正确安装
   - 调整检测线程数
   - 优化模型（量化、剪枝等）

3. **检测精度低**
   - 调整置信度阈值
   - 重新训练针对性模型
   - 检查输入图像预处理

4. **时间同步问题**
   - 调整time_window_ms参数
   - 检查系统时钟同步
   - 优化图像采集频率

### 调试信息

启用调试模式查看详细日志：
- 检测结果统计
- 处理时间分析
- 内存使用情况
- 模型推理性能

## 性能优化

1. **GPU加速**: 确保使用CUDA版本的PyTorch
2. **批处理**: 可以修改代码支持批量推理
3. **模型优化**: 使用TensorRT进行模型加速
4. **多线程**: 调整检测线程数量
5. **内存管理**: 优化图像缓存策略

## 扩展功能

可以考虑添加的功能：
- 更多检测模型支持（YOLO其他版本、其他检测框架）
- 实时性能监控界面
- 检测结果可视化图表
- 网络接口支持远程监控
- 数据库存储检测历史

## 许可证

请参考项目根目录的LICENSE文件。

## 联系方式

如有问题或建议，请联系开发团队。 