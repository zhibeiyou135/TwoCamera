# 递归播放功能实现总结（简化UI版）

## 功能概述

实现了选择一个"主目录"，自动递归播放所有子文件夹（如x1_2025-07-09_13-26-07_07等）下的dv_original和dvs_raw（或dvs_images），并同步送入检测模块，检测结果在UI展示的功能。

**UI简化**：移除了单独的文件播放控件，只保留递归播放功能，界面更加简洁。

## 主要修改文件

### 1. PlaybackReader.h
- 添加了批量播放相关的公共方法：
  - `startBatchPlayback(const QString &rootDir)` - 开始批量播放
  - `stopBatchPlayback()` - 停止批量播放
  - `isBatchPlaybackRunning()` - 检查是否正在批量播放

- 添加了批量播放相关的信号：
  - `batchPlaybackStarted(int totalSessions)` - 批量播放开始
  - `batchPlaybackProgress(int currentSession, int totalSessions, const QString &currentSessionName)` - 播放进度
  - `batchPlaybackFinished()` - 批量播放完成

- 添加了私有成员变量和方法：
  - `SessionInfo` 结构体存储会话信息
  - `m_sessionQueue` 会话队列
  - `m_currentSessionIndex` 当前会话索引
  - `m_batchPlaybackRunning` 批量播放运行状态
  - `collectSessionFolders()` 递归收集会话文件夹
  - `playNextSession()` 播放下一个会话
  - `findDVSFile()` 查找DVS文件
  - `handlePlaybackFinished()` 处理播放完成事件

### 2. PlaybackReader.cpp
- 实现了批量播放的核心逻辑：
  - `startBatchPlayback()` - 收集所有会话并开始播放
  - `stopBatchPlayback()` - 停止批量播放并清理状态
  - `collectSessionFolders()` - 递归遍历目录，查找有效会话
  - `playNextSession()` - 自动播放下一个会话
  - `findDVSFile()` - 在DVS目录中查找.raw或.bin文件
  - `handlePlaybackFinished()` - 处理单个会话播放完成，自动切换到下一个

- 修改了所有`emit playbackFinished()`为`handlePlaybackFinished()`，实现自动切换逻辑

### 3. mainwindow.h
- **简化UI控件**：
  - 移除了单独播放相关的控件指针（selectRecordingFileButton、playRecordingButton等）
  - 只保留递归播放相关的UI控件指针：
    - `selectRootPlaybackDirButton` - 选择主目录按钮
    - `rootPlaybackDirLabel` - 主目录路径显示
    - `batchPlaybackStatusLabel` - 播放状态显示

- **简化槽函数**：
  - 移除了单独播放相关的槽函数
  - 保留递归播放相关的槽函数：
    - `on_selectRootPlaybackDirButton_clicked()` - 选择主目录
    - `onBatchPlaybackStarted()` - 播放开始处理
    - `onBatchPlaybackProgress()` - 播放进度处理
    - `onBatchPlaybackFinished()` - 播放完成处理
    - `onPlaybackImagePair()` - 处理播放的图像对

### 4. mainwindow.cpp
- **简化UI布局**：移除了单独播放控件区域，只保留递归播放控件
- **简化信号连接**：移除了不需要的信号槽连接
- **保留核心功能**：
  - 连接了PlaybackReader的递归播放信号到对应的槽函数
  - 连接了`nextImagePair`信号到检测模块
  - 实现了所有递归播放相关的槽函数
  - 在`onPlaybackImagePair()`中实现了图像到检测模块的传递逻辑

## 核心功能流程

### 1. 会话收集流程
```
用户选择主目录 → collectSessionFolders() 递归遍历 → 检查每个子目录是否包含dv_original和dvs_raw/dvs_images → 构建会话队列
```

### 2. 批量播放流程
```
startBatchPlayback() → 发出batchPlaybackStarted信号 → playNextSession() → 设置DV和DVS路径 → startPlayback() → 播放完成后自动播放下一个
```

### 3. 检测集成流程
```
nextImagePair信号 → onPlaybackImagePair() → 转换图像格式 → 送入DV和DVS检测模块 → 检测结果显示在UI
```

## 支持的目录结构

```
主目录/
├── session1_2025-07-09_13-26-07_01/
│   ├── dv_original/
│   │   ├── 001.jpg
│   │   └── 002.jpg
│   └── dvs_raw/
│       └── data.raw
├── session2_2025-07-09_13-26-07_02/
│   ├── dv_original/
│   └── dvs_images/
└── 子目录/
    └── session3_2025-07-09_13-26-07_03/
        ├── dv_original/
        └── dvs_raw/
```

## 特性

1. **递归搜索** - 自动搜索所有子目录中的有效会话
2. **自动切换** - 一个会话播放完成后自动播放下一个
3. **灵活格式支持** - 支持dvs_raw和dvs_images，支持.raw和.bin文件
4. **检测集成** - 自动将播放的图像送入检测模块
5. **状态显示** - 实时显示播放进度和当前会话
6. **错误处理** - 跳过无效会话，继续播放下一个

## 使用方法（简化版）

1. 点击"选择主目录递归播放"按钮
2. 选择包含多个会话子目录的主目录
3. 系统自动开始递归播放所有有效会话
4. 如果启用了检测功能，播放过程中会自动进行检测
5. 播放完成后显示"已完成"状态

## 注意事项

1. 确保每个会话目录都包含dv_original和dvs_raw/dvs_images
2. DVS文件支持.raw和.bin格式
3. 递归播放过程中会禁用播放按钮防止重复点击
4. 可以随时停止递归播放（关闭程序或等待完成）
5. 检测结果会实时显示在UI上并保存到文件
6. **UI简化**：移除了单独文件播放功能，专注于递归播放
